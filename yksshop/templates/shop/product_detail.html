{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>{{ product.name }} - YKS Men's Wear</title>
  <link rel="stylesheet" href="{% static 'fontawesome/css/all.min.css' %}"/>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }

    header {
      background-color: #fff;
      padding: 15px 40px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    header h1 { color: #007bff; font-size: 24px; }

    nav a {
      color: #333;
      text-decoration: none;
      margin-left: 20px;
    }

    .container {
      max-width: 1000px;
      margin: 40px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 30px;
      display: flex;
      flex-wrap: wrap;
      gap: 30px;
    }

    .product-media {
      display: flex;
      flex-direction: column;
      gap: 16px;
      align-items: flex-start;
    }

    .main-image {
      width: 400px;
      height: 400px;
      border-radius: 8px;
      overflow: hidden;
      background: #f1f1f1;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .main-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .thumbnail-grid {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .thumbnail {
      width: 72px;
      height: 72px;
      border-radius: 8px;
      overflow: hidden;
      border: 2px solid transparent;
      cursor: pointer;
      transition: border-color 0.2s ease;
    }

    .thumbnail img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .thumbnail.active {
      border-color: #007bff;
    }

    .product-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .product-name {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 10px;
      color: #333;
    }

    .product-price {
      font-size: 24px;
      color: #28a745;
      margin-bottom: 15px;
    }

    .size-selector {
      margin-bottom: 20px;
    }

    .size-label {
      font-weight: 600;
      margin-bottom: 10px;
      color: #333;
    }

    .size-options {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .size-option {
      padding: 8px 14px;
      border-radius: 6px;
      border: 1px solid #007bff;
      background: white;
      cursor: pointer;
      font-weight: 600;
      color: #007bff;
      transition: all 0.2s ease;
    }

    .size-option:hover {
      background: #007bff;
      color: white;
    }

    .size-option.active {
      background: #007bff;
      color: white;
    }

    .size-option:disabled,
    .size-option.disabled {
      border-color: #ccc;
      color: #aaa;
      cursor: not-allowed;
      background: #f4f4f4;
    }

    .stock-status {
      font-size: 15px;
      color: #555;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .product-description {
      font-size: 16px;
      color: #555;
      margin-bottom: 20px;
    }

    .add-to-cart-btn {
      background-color: #007bff;
      color: white;
      padding: 12px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 16px;
    }

    .add-to-cart-btn:hover {
      background-color: #0056b3;
    }

    .add-to-cart-btn[disabled] {
      background-color: #ccc;
      color: #777;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <header>
    <h1><i class="fas fa-tshirt"></i> YKS Men's Wear</h1>
    <nav>
      <a href="{% url 'homepage' %}">Home</a>
      <a href="{% url 'product_list' %}">Shop</a>
      {% if user.is_authenticated %}
        <a href="{% url 'view_cart' %}">Cart ({{ cart_count }})</a>
      {% endif %}
    </nav>
  </header>

  <div class="container">
    <div class="product-media">
      <div class="main-image">
        {% with image_list=product.gallery_images %}
          {% if image_list %}
            {% with primary_image=image_list.0 %}
              <img id="main-product-image"
                   src="{{ primary_image }}"
                   alt="{{ product.name }}"
                   onerror="this.src='https://via.placeholder.com/400x400?text=No+Image'">
            {% endwith %}
          {% else %}
            <img id="main-product-image"
                 src="https://via.placeholder.com/400x400?text=No+Image"
                 alt="{{ product.name }}">
          {% endif %}
        {% endwith %}
      </div>

      {% if product.gallery_images|length > 1 %}
        <div class="thumbnail-grid" id="product-thumbnail-grid">
          {% for image in product.gallery_images %}
            <div class="thumbnail{% if forloop.first %} active{% endif %}"
                 data-image="{{ image }}">
              <img src="{{ image }}"
                   alt="{{ product.name }} thumbnail {{ forloop.counter }}"
                   onerror="this.src='https://via.placeholder.com/100x100?text=No+Image'">
            </div>
          {% endfor %}
        </div>
      {% endif %}
    </div>

    <div class="product-details">
      <h2 class="product-name">{{ product.name }}</h2>
      <p class="product-price">Rs.{{ product.price }}</p>
      <p class="stock-status">
        {% if product.total_stock > 0 %}
          <i class="fas fa-check-circle" style="color: #28a745;"></i>
          In Stock ({{ product.total_stock }})
        {% else %}
          <i class="fas fa-times-circle" style="color: #dc3545;"></i>
          Out of Stock
        {% endif %}
      </p>
      {% if product.has_size_variants %}
        <div class="size-selector">
          <div class="size-label">Select Size:</div>
          <div class="size-options" id="size-options">
            {% for variant in variants %}
              <button type="button"
                      class="size-option{% if variant.stock == 0 %} disabled{% endif %}"
                      data-size="{{ variant.size }}"
                      {% if variant.stock == 0 %}disabled{% endif %}>
                {{ variant.size }}
                {% if variant.stock == 0 %} (Out){% endif %}
              </button>
            {% endfor %}
          </div>
        </div>
      {% endif %}
      <p class="product-description">{{ product.description }}</p>

      <button class="add-to-cart-btn"
              {% if product.total_stock == 0 %}
                disabled
              {% else %}
                onclick="addToCart({{ product.id }})"
              {% endif %}>
        <i class="fas fa-cart-plus"></i> Add to Cart
      </button>
    </div>
  </div>

  <script>
  const thumbnailGrid = document.getElementById('product-thumbnail-grid');
  const mainImage = document.getElementById('main-product-image');
  const sizeOptions = document.querySelectorAll('.size-option');
  let selectedSize = null;

  if (thumbnailGrid && mainImage) {
    thumbnailGrid.addEventListener('click', function(event) {
      const target = event.target.closest('.thumbnail');
      if (!target) return;

      const newSrc = target.dataset.image;
      if (newSrc) {
        mainImage.src = newSrc;

        const activeThumb = thumbnailGrid.querySelector('.thumbnail.active');
        if (activeThumb) {
          activeThumb.classList.remove('active');
        }
        target.classList.add('active');
      }
    });
  }

  if (sizeOptions.length > 0) {
    const firstAvailable = Array.from(sizeOptions).find(button => !button.disabled);
    if (firstAvailable) {
      firstAvailable.classList.add('active');
      selectedSize = firstAvailable.dataset.size;
    }

    sizeOptions.forEach(button => {
      if (button.disabled) {
        return;
      }
      button.addEventListener('click', () => {
        sizeOptions.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');
        selectedSize = button.dataset.size;
      });
    });
  }

  function addToCart(productId) {
    {% if user.is_authenticated %}
      if (sizeOptions.length > 0 && !selectedSize) {
        alert('Please select a size before adding to cart.');
        return;
      }

      const formData = new FormData();
      formData.append('product_id', productId);
      formData.append('quantity', '1');
      formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');
      if (selectedSize) {
        formData.append('size', selectedSize);
      }

      fetch('{% url "add_to_cart" %}', {
        method: 'POST',
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          window.location.href = "{% url 'view_cart' %}";
        } else {
          alert(data.message || "Unable to add product to cart.");
        }
      })
      .catch(error => {
        console.error('Error:', error);
        alert("Something went wrong. Please try again.");
      });
    {% else %}
      window.location.href = "{% url 'login' %}";
    {% endif %}
  }
  </script>
</body>
</html>
